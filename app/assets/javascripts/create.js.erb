
<% 
# This file is for displaying search results from user input in plant creation.
# Should update a text_fields suggestions with displayed names from a search.
# This allows the following searches first result to be the intended location.

# https://nominatim.openstreetmap.org/search/<query>?<params>
# https://nominatim.openstreetmap.org/search?q=17+Strada+Pictor+Alexandru+Romano%2C+Bukarest&format=geojson
%>

function search_locations() {

  Rails.ajax({

    <%# Ajax request from controller method get_gecode%>
    url: "/get_geocode_results?string=" + Rails.$(".loc-field")[0].value,
    type: "get",
    success:  function retData(data){
      <%# Split returned array %>
      results_array = data.split("|")

      <%# Assign location field as first in class ".loc-field" %>
      location_field = Rails.$(".loc-field")[0]

      <%# Create array of HTML links (<a> tags) %>
      links = [ document.createElement("A"), document.createElement("A"), document.createElement("A"), document.createElement("A") ]

      <%# add "suggest" class to location field (removes bottom curved corners) %>
      location_field.classList.add("suggest")

      <%# Check if child elements exist for creation or edit %>
      if(Rails.$(".location_field")[0].childElementCount<4){
        for (i=0;i<4;i++) {
          links[i].className = "location-suggest-"+i
          links[i].innerHTML = results_array[i];
          links[i].onclick = function() { Rails.$(".loc-field")[0].value = this.innerHTML;
           remove_links("location_field", "location-suggest") }
        }
        <%# Append/create only as many that exist %>
        for (i=0;i<4&&results_array[i]!=null;i++) {
            if (results_array[i].length > 0) { Rails.$(".location_field")[0].appendChild(links[i]); }
        }
      }else{
        <%# For all suggestion links (out of the possible 4) that exist on the page, change text to corresponding string in API results %>
        if (Rails.$(".location-suggest-0").length != 0) {
          Rails.$(".location-suggest-0")[0].innerHTML = results_array[0]
        }
        if (Rails.$(".location-suggest-1").length != 0) {
          Rails.$(".location-suggest-1")[0].innerHTML = results_array[1]
        }
        if (Rails.$(".location-suggest-2").length != 0) {
          Rails.$(".location-suggest-2")[0].innerHTML = results_array[2]
        }
        if (Rails.$(".location-suggest-3").length != 0) {
          Rails.$(".location-suggest-3")[0].innerHTML = results_array[3]
        }
      }
    }
    <%# END Success Function %>
  })
  <%# END Ajax %>
} 

<%# Remove Elements upon clicking one %>
function remove_links(field, suggests) {
    Rails.$("."+field)[0].classList.remove("suggest")
    for(i=0;i<Rails.$("."+field)[0].childElementCount+1;++i){
      if (Rails.$("."+suggests+'-'+i)[0]!=null){
        Rails.$("."+suggests+'-'+i)[0].remove()
        
      }
    }
}

function search_species(){

  Rails.ajax({

    <%# Ajax request from controller method get_spec%>
    url: "/get_spec_results?toSearch=" + Rails.$(".spec-field")[0].value,
    type: "get",
    success:  function retData(data){
      <%# Split returned array %>
      hold_array = data.split("|")
      final_array = []
      for(i=0;i<hold_array.length;++i){
        check_array = hold_array[i].split(',')
        final_array[i] = check_array
      }
      
      <%# Assign species field as first in class ".species-field" %>
      species_field = Rails.$(".species_field")[0]

      <%# Create array of HTML links (<a> tags) %>
      links = [ document.createElement("A"), document.createElement("A"), document.createElement("A"), document.createElement("A") ]

      <%# add "suggest" class to species field (removes bottom curved corners) %>
      species_field.classList.add("suggest")

      <%# Check if child elements exist for creation or edit %>
      if(Rails.$(".species_field")[0].childElementCount>2){
        remove_links("species_field","species-suggest")
      }
      for (i=0;i<4&&final_array[i];i++) {
        links[i].className = "species-suggest-"+i
        links[i].innerHTML = final_array[i][0];
        links[i].onclick = function() { Rails.$(".spec-field")[0].value = this.innerHTML; 
         remove_links("species_field", "species-suggest") }
      }
      <%# Append/create only as many that exist %>
      for (i=0;i<4&&final_array[i]!=null;i++) {
          if (final_array[i].length > 0) { Rails.$(".species_field")[0].appendChild(links[i]); }
      }
    }
    <%# END Success Function %>
  })
  <%# END Ajax %>
  }

